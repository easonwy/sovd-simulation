// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  role      String     @default("Viewer") // Viewer | Developer | Admin
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@map("users")
}

// SOVD Entity (Component, App, Area, Function)
model SOVDEntity {
  id         String   @id @default(cuid())
  entityId   String   // e.g., "WindowControl"
  collection String   // Area | Component | App | Function
  name       String
  type       String?  // Entity type
  category   String?  // Optional category
  description String? // Optional description
  status     String   @default("active") // active | inactive | archived
  metadata   String?  // JSON metadata

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  dataValues      DataValue[]
  faults          Fault[]
  locks           Lock[]
  logEntries      LogEntry[]
  operations      Operation[]
  modes           Mode[]
  configurations  Configuration[]

  @@unique([entityId, collection])
  @@index([collection])
  @@index([collection, createdAt])
  @@map("sovd_entities")
}

// Data value storage
model DataValue {
  id        String   @id @default(cuid())
  entityId  String
  entity    SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  dataId    String     // e.g., "DriverWindow"
  value     String     // JSON-serialized value
  type      String     @default("dynamic") // dynamic | static | computed
  unit      String?    // Optional unit (e.g., "Â°C", "km/h")
  category  String?    // e.g., "currentData", "identData"
  status    String     @default("active") // active | inactive | error
  createdAt DateTime   @default(now())
  timestamp DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([entityId, dataId])
  @@index([category])
  @@index([dataId])
  @@index([entityId, dataId])
  @@map("data_values")
}

// Fault storage
model Fault {
  id        String   @id @default(cuid())
  entityId  String
  entity    SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  code      String     // e.g., "DTC-001"
  title     String?    // Human-readable fault title
  description String?  // Detailed description
  status    String     @default("active") // "active" | "confirmed" | "resolved"
  severity  String     @default("high") // critical | high | medium | low
  metadata  String?    // JSON metadata with status fields
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([entityId, code])
  @@index([status])
  @@index([entityId, status])
  @@index([createdAt])
  @@map("faults")
}

// Lock storage
model Lock {
  id        String   @id @default(cuid())
  entityId  String
  entity    SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@map("locks")
}

// Log entry storage
model LogEntry {
  id        String   @id @default(cuid())
  entityId  String
  entity    SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  severity  String     @default("info") // info | warning | error | critical
  message   String
  category  String?    // e.g., "fault", "operation", "data"
  metadata  String?    // JSON metadata
  timestamp DateTime   @default(now())
  createdAt DateTime   @default(now())

  @@index([severity])
  @@index([entityId, timestamp])
  @@map("log_entries")
}

// Operation storage
model Operation {
  id              String   @id @default(cuid())
  entityId        String
  entity          SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  operationId     String  // e.g., "restart"
  name            String
  description     String?
  parameters      String?  // JSON schema for operation parameters
  expectedOutput  String?  // Expected output schema
  status          String  @default("available") // available | unavailable | deprecated
  metadata        String?  // JSON metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  executions      OperationExecution[]

  @@unique([entityId, operationId])
  @@map("operations")
}

// Operation execution records
model OperationExecution {
  id              String   @id @default(cuid())
  executionId     String   @unique // Unique execution identifier
  operationId     String
  entityId        String   // Denormalized for easier querying
  operation       Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  parameters      String?   // Input parameters
  status          String   @default("in-progress") // in-progress | completed | failed
  result          String?   // JSON result data
  error           String?  // Error message if failed
  timestamp       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([operationId, timestamp])
  @@map("operation_executions")
}

// Mode storage
model Mode {
  id        String   @id @default(cuid())
  entityId  String
  entity    SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  modeId    String     // e.g., "test-mode"
  name      String
  metadata  String?    // JSON metadata
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([entityId, modeId])
  @@map("modes")
}

// Configuration storage
model Configuration {
  id        String   @id @default(cuid())
  entityId  String
  entity    SOVDEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  configId  String     // Configuration identifier
  name      String
  type      String     // "bulk" | "parameter"
  value     String?    // JSON configuration value
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([entityId, configId])
  @@map("configurations")
}

// Permission/RBAC configuration
model Permission {
  id          String   @id @default(cuid())
  role        String     // Viewer | Developer | Admin
  pathPattern String   // e.g., "/v1/App/*/data/*"
  method      String     // GET | POST | PUT | DELETE
  access      String     // { allowed: boolean, reason?: string }
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([role, pathPattern, method])
  @@index([role])
  @@map("permissions")
}

// Data snapshot for time-series visualization
model DataSnapshot {
  id        String   @id @default(cuid())
  dataId    String
  entityId  String
  value     String     // JSON-serialized value
  timestamp DateTime   @default(now())

  @@index([dataId, timestamp])
  @@index([entityId, timestamp])
  @@map("data_snapshots")
}

// Audit log for compliance and monitoring
model AuditLog {
  id        String   @id @default(cuid())
  userId    String   // User ID or system
  action    String   // CREATE | UPDATE | DELETE | READ | LOGIN | etc
  resource  String   // Path, entity type, or resource identifier
  result    String   // success | error
  details   String?  // JSON details
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([resource, timestamp])
  @@index([action])
  @@map("audit_logs")
}

// Update package tracking
model UpdatePackage {
  id        String   @id @default(cuid())
  updateId  String     // Update package identifier
  name      String
  version   String?
  origin    String?    // Origin information
  automated Boolean    @default(false)
  status    String     // "pending" | "preparing" | "executing" | "completed" | "failed"
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([updateId])
  @@map("update_packages")
}
