import { NextRequest, NextResponse } from 'next/server'
import { generateEnhancedToken } from '@/lib/enhanced-jwt'
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

export const runtime = 'nodejs'

function parseBody(contentType: string | null, raw: string) {
  if (contentType && contentType.includes('application/x-www-form-urlencoded')) {
    const params = new URLSearchParams(raw)
    const obj: Record<string, string> = {}
    params.forEach((v, k) => (obj[k] = v))
    return obj
  }
  try {
    return JSON.parse(raw)
  } catch {
    return {}
  }
}

export async function POST(req: NextRequest) {
  try {
    const ct = req.headers.get('content-type')
    const raw = await req.text()
    const body = parseBody(ct, raw)
    
    const role = (body.role || 'Viewer') as 'Viewer' | 'Developer' | 'Admin'
    const grant = body.grant_type || 'client_credentials'
    const expiresIn = body.expires_in || '1h'
    
    if (!grant) {
      return NextResponse.json({ error: 'invalid_request' }, { status: 400 })
    }

    // 获取角色权限
    const permissions = await getRolePermissions(role)

    // 使用增强的JWT工具生成Token
    const tokenResult = await generateEnhancedToken({
      userId: 'system', // 系统生成的Token
      email: 'system@sovd.local',
      role,
      oid: 'default',
      permissions,
      scope: 'api:access',
      clientId: 'sovd-cli'
    }, {
      expiresIn,
      issuer: 'sovd-system',
      audience: 'sovd-api'
    })

    return NextResponse.json({
      access_token: tokenResult.token,
      token_type: 'Bearer',
      expires_in: Math.floor((tokenResult.expiresAt.getTime() - Date.now()) / 1000),
      scope: 'api:access',
      permissions
    }, { status: 200 })
  } catch (error) {
    console.error('Token generation error:', error)
    return NextResponse.json({
      error: 'token_generation_failed',
      error_description: 'Failed to generate access token'
    }, { status: 500 })
  }
}

/**
 * 获取角色权限列表
 */
async function getRolePermissions(role: string): Promise<string[]> {
  try {
    // 从数据库获取角色权限
    const rolePermissions = await prisma.permission.findMany({
      where: { role },
      select: { method: true, pathPattern: true }
    })

    // 转换为权限字符串格式
    const permissions = rolePermissions.map(perm => 
      `${perm.method}:${perm.pathPattern}`
    )

    // 添加基础权限
    const basePermissions = getBasePermissions(role)
    
    return [...new Set([...basePermissions, ...permissions])]
  } catch (error) {
    console.error('获取角色权限失败:', error)
    return getBasePermissions(role)
  }
}

/**
 * 获取基础权限
 */
function getBasePermissions(role: string): string[] {
  const basePerms = {
    'Viewer': [
      'GET:/v1/App',
      'GET:/v1/App/*/data',
      'GET:/v1/App/*/faults'
    ],
    'Developer': [
      'GET:/v1/App',
      'POST:/v1/App',
      'GET:/v1/App/*/data',
      'POST:/v1/App/*/data',
      'PUT:/v1/App/*/data',
      'GET:/v1/App/*/faults',
      'POST:/v1/App/*/faults',
      'DELETE:/v1/App/*/faults',
      'GET:/v1/App/*/lock'
    ],
    'Admin': ['*'] // 管理员拥有所有权限
  }

  return basePerms[role as keyof typeof basePerms] || []
}